---
import { Image } from 'astro:assets';

interface Post {
  id: number;
  title: string;
  description: string;
  url: string;
  cover_image: string;
  social_image: string;
  published_at: string;
  tag_list: string[];
}

const USERNAME = 'enlabe';
const LIMIT = 6;
let posts: Post[] = [];
let error = false;

try {
  const response = await fetch(`https://dev.to/api/articles?username=${USERNAME}&per_page=${LIMIT}`);
  if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
  posts = await response.json();
} catch (err) {
  console.error('[Blog Fetch Error]:', err);
  error = true;
}

const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
};
---

{error ? (
  <div class="text-center py-12">
    <p class="text-red-500 dark:text-red-400 mb-2 font-medium">No pudimos cargar los art√≠culos recientes.</p>
    <a href={`https://dev.to/${USERNAME}`} target="_blank" class="text-sm font-medium underline">Visita mi perfil en Dev.to</a>
  </div>
) : (
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
    {posts.map((post) => {
      const image = post.cover_image || post.social_image || 'https://placehold.co/600x400/e2e8f0/1e293b?text=No+Image';
      const date = formatDate(post.published_at);
      const tag = (post.tag_list && post.tag_list.length > 0) ? `#${post.tag_list[0]}` : '#Blog';

      return (
        <a href={post.url} target="_blank" rel="noopener noreferrer" class="block group h-full">
          <article class="bg-gray-50 dark:bg-gray-800 rounded-2xl overflow-hidden shadow-sm hover:shadow-lg transition-all duration-300 border border-gray-100 dark:border-gray-700 h-full flex flex-col transform group-hover:-translate-y-1">
            <div class="aspect-video overflow-hidden relative bg-gray-200 dark:bg-gray-700">
               <Image 
                src={image} 
                alt={post.title} 
                width={600}
                height={338}
                class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" 
                loading="lazy" 
                decoding="async"
                inferSize={true}
              />
            </div>
            <div class="p-6 flex-1 flex flex-col">
              <div class="flex items-center justify-between mb-3">
                <span class="text-xs font-semibold px-2.5 py-1 rounded-full bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 uppercase tracking-wide">
                  {tag}
                </span>
                <span class="text-xs text-gray-500 dark:text-gray-400 flex items-center gap-1">
                  {date}
                </span>
              </div>
              <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors line-clamp-2">
                {post.title}
              </h3>
              <p class="text-gray-600 dark:text-gray-400 text-sm line-clamp-3 mb-4 flex-1 leading-relaxed">
                {post.description}
              </p>
              <div class="flex items-center gap-2 text-sm font-bold text-blue-600 dark:text-blue-400 mt-auto pt-2">
                Read Article 
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform group-hover:translate-x-1"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
              </div>
            </div>
          </article>
        </a>
      );
    })}
  </div>
)}
